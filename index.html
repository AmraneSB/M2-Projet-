<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apollo Beats — Prototype SPA</title>
<style>
  :root{
    --bg:#f6f7fb;
    --primary:#6a5acd;
    --primary-strong:#5a40c8;
    --card:#ffffff;
    --muted:#6b6b80;
    --accent:#ffcc00;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg); color:#222;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    display:flex;flex-direction:column;
  }

  /* Header */
  header.appbar{
    background:linear-gradient(180deg,var(--primary),var(--primary-strong));
    color:white;padding:14px 16px;display:flex;align-items:center;gap:12px;
    position:sticky;top:0;z-index:50;box-shadow:0 6px 20px rgba(106,90,205,0.12);
  }
  header .brand{
    display:flex;align-items:center;gap:12px;
  }
  header img.logo{width:48px;height:48px;border-radius:10px;object-fit:cover}
  header h1{font-size:18px;margin:0}
  header p.sub{margin:0;font-size:12px;opacity:0.95}

  main{padding:16px;flex:1;max-width:720px;margin:0 auto;width:100%}

  /* controls */
  .controls{display:flex;gap:8px;justify-content:center;margin-top:12px;margin-bottom:16px}
  .btn{
    background:var(--card);border-radius:999px;padding:8px 12px;border:none;cursor:pointer;
    box-shadow:0 2px 6px rgba(15,15,30,0.04);font-weight:600;color:var(--primary);
  }
  .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;box-shadow:0 6px 18px rgba(90,64,200,0.16)}
  .small{padding:6px 10px;font-size:14px}

  /* current room title + animation */
  .room-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .room-title h2{margin:0;font-size:18px}
  .fade-in{animation:fadeIn .35s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  /* grid of artworks */
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .card{
    background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:0 6px 18px rgba(22,22,45,0.05);
    cursor:pointer;display:flex;flex-direction:column;transition:transform .18s ease,box-shadow .18s;
  }
  .card:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(22,22,45,0.08)}
  .thumb{width:100%;height:120px;object-fit:cover;display:block}
  .card .meta{padding:10px}
  .card h3{margin:0;font-size:15px}
  .meta-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .muted{color:var(--muted);font-size:13px}

  /* bottom area */
  .bottom-bar{position:sticky;bottom:12px;margin-top:18px}
  .collection{
    background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,0.98));
    border-radius:12px;padding:10px;box-shadow:0 8px 30px rgba(10,10,20,0.06);
  }
  .collection h4{margin:0 0 8px 0}
  .collection ul{margin:0;padding:0 12px;max-height:180px;overflow:auto}
  .collection li{list-style:none;padding:8px 0;border-bottom:1px dashed #efefef;font-size:14px}

  /* icons buttons */
  .icon-btn{background:transparent;border:none;cursor:pointer;padding:6px;border-radius:8px}
  .fav-active{color:var(--accent);filter:drop-shadow(0 2px 6px rgba(255,204,0,0.15))}

  /* overlay audio permission */
  .audio-overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(6,6,12,0.45);z-index:80;
  }
  .audio-card{background:white;padding:18px;border-radius:12px;text-align:center;width:90%;max-width:380px}
  .audio-card p{margin:8px 0 14px 0}
  .help{font-size:13px;color:#555;margin-top:8px}

  /* responsive tweaks */
  @media (max-width:520px){
    .grid{grid-template-columns:1fr}
    header h1{font-size:16px}
    header img.logo{width:44px;height:44px}
  }
</style>
</head>
<body>

<header class="appbar">
  <div class="brand">
    <img class="logo" src="assets/LogoAB.png" alt="Logo Apollo Beats" onerror="this.style.opacity=0.6">
    <div>
      <h1>Apollo Beats</h1>
      <p class="sub">Prototype — visite guidée intelligente</p>
    </div>
  </div>

  <!-- right controls -->
  <div style="margin-left:auto;display:flex;gap:8px">
    <button class="btn small" id="simulateBtn" title="Simuler détection Wi-Fi">Simuler Wi-Fi</button>
    <button class="btn small" id="openCollectionBtn" title="Voir ma collection">Collection</button>
  </div>
</header>

<main>
  <!-- automatic detection message -->
  <div id="status" style="text-align:center;margin-top:12px;color:#333;font-size:14px">En attente de détection Wi-Fi…</div>

  <!-- room title -->
  <div class="room-title fade-in" id="roomTitle" style="display:none">
    <h2 id="roomName">Salle</h2>
    <div id="roomStats" class="muted">0 œuvres</div>
  </div>

  <!-- artworks -->
  <div id="grid" class="grid" aria-live="polite"></div>

  <!-- bottom collection -->
  <div class="bottom-bar">
    <div class="collection">
      <h4>Ma collection (favoris + consultées)</h4>
      <ul id="collectionList"></ul>
    </div>
  </div>
</main>

<!-- Audio permission overlay (browser autoplay policy) -->
<div id="audioOverlay" class="audio-overlay" style="display:none">
  <div class="audio-card">
    <h3>Activer le son</h3>
    <p>Pour tester la lecture audio automatique dans le prototype, merci de cliquer pour autoriser le son.</p>
    <button id="enableSound" class="btn primary">Activer le son</button>
    <div class="help">(Autorisation nécessaire une seule fois par session)</div>
  </div>
</div>

<script>
/* ---------- Prototype data (3 salles) ---------- */
const ROOMS = {
  impressionnisme: {
    id: 'impressionnisme',
    name: 'Salle Impressionnisme',
    artworks: [
      { id:'renoir', title:'Bal du Moulin de la Galette — Renoir', img:'https://upload.wikimedia.org/wikipedia/commons/6/6e/Pierre-Auguste_Renoir_-_Bal_du_moulin_de_la_galette.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
      { id:'monet', title:'Impression, Soleil Levant — Monet', img:'https://upload.wikimedia.org/wikipedia/commons/4/44/Claude_Monet%2C_Impression%2C_soleil_levant.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' }
    ]
  },
  modernisme: {
    id: 'modernisme',
    name: 'Salle Modernisme',
    artworks: [
      { id:'picasso', title:"Les Demoiselles d'Avignon — Picasso", img:'https://upload.wikimedia.org/wikipedia/en/d/d7/Les_Demoiselles_d%27Avignon.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
      { id:'delaunay', title:'Carré — Robert Delaunay', img:'https://upload.wikimedia.org/wikipedia/commons/5/5a/Robert_Delaunay%2C_1912-13%2C_Carr%C3%A9_1912-13.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' }
    ]
  },
  sculpture: {
    id:'sculpture',
    name:'Salle Sculpture & Photo',
    artworks:[
      { id:'rodin', title:'Le Penseur — Rodin', img:'https://upload.wikimedia.org/wikipedia/commons/8/83/Le_Penseur_Rodin.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' },
      { id:'man_ray', title:'Noir et Blanc — Man Ray', img:'https://upload.wikimedia.org/wikipedia/commons/3/34/Man_Ray_%281885-1976%29_-_Flatiron_Building%2C_New_York%2C_1928.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3' }
    ]
  }
};

/* ---------- State ---------- */
let currentRoom = null;
let currentAudio = null;        // HTMLAudioElement for artwork playback
let transitionAllowed = false;  // set after user enables audio overlay
let favorites = new Set(JSON.parse(localStorage.getItem('ab_favs')||'[]'));
let visited = new Set(JSON.parse(localStorage.getItem('ab_visited')||'[]'));

/* ---------- DOM refs ---------- */
const grid = document.getElementById('grid');
const roomName = document.getElementById('roomName');
const roomStats = document.getElementById('roomStats');
const status = document.getElementById('status');
const roomTitle = document.getElementById('roomTitle');
const collectionList = document.getElementById('collectionList');
const simulateBtn = document.getElementById('simulateBtn');
const audioOverlay = document.getElementById('audioOverlay');
const enableSoundBtn = document.getElementById('enableSound');
const openCollectionBtn = document.getElementById('openCollectionBtn');

/* ---------- Helpers ---------- */
function saveState(){
  localStorage.setItem('ab_favs', JSON.stringify(Array.from(favorites)));
  localStorage.setItem('ab_visited', JSON.stringify(Array.from(visited)));
}

function playTransitionTone(duration=120, freq=880, vol=0.15){
  // small transition "ping" using WebAudio (no external file)
  if(!transitionAllowed) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine'; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, duration);
  }catch(e){ console.warn('WebAudio not available', e) }
}

/* ---------- UI rendering ---------- */
function renderRoom(room){
  currentRoom = room;
  playTransitionTone(); // fx when arriving in a room
  roomName.textContent = room.name;
  roomStats.textContent = `${room.artworks.length} œuvres`;
  roomTitle.style.display = 'flex';
  status.style.display = 'none';
  grid.innerHTML = '';

  room.artworks.forEach(art => {
    const card = document.createElement('div');
    card.className = 'card fade-in';
    card.setAttribute('role','button');
    card.setAttribute('tabindex','0');

    // card inner html
    card.innerHTML = `
      <img class="thumb" src="${art.img}" alt="${escapeHtml(art.title)}">
      <div class="meta">
        <h3>${escapeHtml(art.title)}</h3>
        <div class="meta-row">
          <div class="muted">Cliquer pour écouter</div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="icon-btn" title="Favoris" data-art="${art.id}" aria-label="Favoris">
              ${favorites.has(art.id) ? starSvg(true) : starSvg(false)}
            </button>
            <button class="icon-btn" title="Écouter" data-play="${art.id}" aria-label="Écouter">
              ${playSvg()}
            </button>
          </div>
        </div>
      </div>
    `;

    // click card or Play button -> play
    card.addEventListener('click', (e)=>{
      // avoid double triggering when clicking the fav icon
      const favBtn = e.target.closest('button[data-art]');
      const playBtn = e.target.closest('button[data-play]');
      if(favBtn){ toggleFav(favBtn.getAttribute('data-art')); e.stopPropagation(); return; }
      if(playBtn){ playArtworkById(playBtn.getAttribute('data-play')); e.stopPropagation(); return; }
      // otherwise clicking the card plays first artwork fallback
      playArtworkById(art.id);
    });

    // keyboard accessibility: enter/space to play
    card.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); playArtworkById(art.id); }
    });

    grid.appendChild(card);
  });
}

/* escape helper to avoid naive html injection */
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

/* ---------- Audio management ---------- */
function stopCurrentAudio(){
  if(currentAudio){
    try{
      currentAudio.pause();
      currentAudio.currentTime = 0;
    }catch(e){}
    currentAudio = null;
  }
}

/* Play artwork by id (stops previous audio automatically) */
function playArtworkById(id){
  const art = findArtwork(id);
  if(!art) return;
  // if not allowed yet, show overlay for user to enable sound
  if(!transitionAllowed){
    showAudioOverlay();
    return;
  }

  // play small transition tone then play main audio after short delay
  playTransitionTone(90,1200,0.08);

  // stop old audio
  stopCurrentAudio();

  // create new audio and play
  currentAudio = new Audio(art.audio);
  currentAudio.preload = 'auto';
  currentAudio.addEventListener('canplaythrough', ()=>{ currentAudio.play().catch(()=>{/* autoplay blocked */}); });
  currentAudio.addEventListener('ended', ()=>{ currentAudio = null; });
  // mark visited & update UI
  visited.add(art.id); saveState(); renderCollection();
  // subtle UI feedback: highlight the card briefly
  flashArtworkCard(id);
}

/* find art in ROOMS */
function findArtwork(id){
  for(const r of Object.values(ROOMS)){
    for(const a of r.artworks) if(a.id === id) return a;
  }
  return null;
}

/* flash card */
function flashArtworkCard(id){
  const btns = [...document.querySelectorAll(`[data-play="${id}"]`)];
  if(btns.length>0){
    const card = btns[0].closest('.card');
    card.style.transition = 'transform .12s';
    card.style.transform = 'scale(1.02)';
    setTimeout(()=>{ card.style.transform = ''; }, 260);
  }
}

/* ---------- Favorites & Collection ---------- */
function toggleFav(id){
  if(favorites.has(id)) favorites.delete(id); else favorites.add(id);
  saveState();
  renderRoom(currentRoom);
  renderCollection();
}

/* render collection list (favorites first) */
function renderCollection(){
  collectionList.innerHTML = '';
  // favorites
  if(favorites.size>0){
    const favHeader = document.createElement('li'); favHeader.textContent = 'Favoris'; favHeader.style.fontWeight='700';
    collectionList.appendChild(favHeader);
    for(const id of favorites){
      const art = findArtwork(id);
      if(!art) continue;
      const li = document.createElement('li');
      li.innerHTML = `${escapeHtml(art.title)} <button class="btn small" style="float:right" onclick="playArtworkById('${art.id}')">Écouter</button>`;
      collectionList.appendChild(li);
    }
  }
  // visited (but not in favorites)
  const otherVisited = [...visited].filter(id=>!favorites.has(id));
  if(otherVisited.length>0){
    const header = document.createElement('li'); header.textContent = 'Consultées'; header.style.fontWeight='700'; header.style.marginTop='8px';
    collectionList.appendChild(header);
    otherVisited.forEach(id=>{
      const art = findArtwork(id);
      if(!art) return;
      const li = document.createElement('li');
      li.innerHTML = `${escapeHtml(art.title)} <button class="btn small" style="float:right" onclick="playArtworkById('${art.id}')">Écouter</button>`;
      collectionList.appendChild(li);
    });
  }

  if(favorites.size===0 && otherVisited.length===0){
    const li = document.createElement('li'); li.textContent = 'Aucune œuvre pour le moment. Cliquez sur une œuvre pour l’écouter.'; collectionList.appendChild(li);
  }
}

/* ---------- Simulate Wi-Fi detection ---------- */
function simulateDetection(){
  status.textContent = 'Détection Wi-Fi en cours…';
  // small UX delay
  setTimeout(()=>{
    // pick a random room
    const keys = Object.keys(ROOMS);
    const choice = keys[Math.floor(Math.random()*keys.length)];
    renderRoom(ROOMS[choice]);
  }, 700);
}

/* ---------- Overlay & initial activation ---------- */
function showAudioOverlay(){ audioOverlay.style.display='flex'; }
function hideAudioOverlay(){ audioOverlay.style.display='none'; }

/* ---------- Utility svg icons ---------- */
function starSvg(active=false){
  if(active){
    return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 17.3l-6.16 3.24 1.18-6.88L2.7 9.76l6.95-1.01L12 2.5l2.35 6.25 6.95 1.01-4.32 4.9 1.18 6.88z" fill="#FFCC00"/></svg>`;
  }
  return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 17.3l-6.16 3.24 1.18-6.88L2.7 9.76l6.95-1.01L12 2.5l2.35 6.25 6.95 1.01-4.32 4.9 1.18 6.88z" stroke="#bbb" stroke-width="1.2" fill="none"/></svg>`;
}
function playSvg(){
  return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M5 3v18l15-9z" fill="#6a5acd"/></svg>`;
}

/* ---------- keyboard + UI wiring ---------- */
simulateBtn.addEventListener('click', simulateDetection);
openCollectionBtn.addEventListener('click', ()=>{ window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); });

enableSoundBtn.addEventListener('click', ()=>{
  transitionAllowed = true;
  // play a tiny click to ensure audio context allowed
  playTransitionTone(80,1000,0.06);
  hideAudioOverlay();
});

/* On first load: show overlay so user can allow audio if they want automatic playback */
window.addEventListener('load', ()=>{
  // if there's already visited or user clicks quickly, it's ok; still show overlay to enable sounds
  audioOverlay.style.display = 'flex';
  renderCollection();
});

/* Optional: auto simulate detection shortly after user enables sound (for demo) */
audioOverlay.addEventListener('transitionend', ()=>{ /* noop */ });

/* Accessible: space/enter also enable sound when overlay focused */
audioOverlay.addEventListener('keydown', (e)=>{ if((e.key==='Enter' || e.key===' ') && document.activeElement===enableSoundBtn) enableSoundBtn.click(); });

/* small helper: expose functions to global for collection buttons */
window.playArtworkById = playArtworkById;
window.toggleFav = toggleFav;

</script>
</body>
</html>
