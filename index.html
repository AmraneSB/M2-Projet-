<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apollo Beats — Prototype SPA</title>
<style>
  :root{
    --bg:#f6f7fb;
    --primary:#6a5acd;
    --primary-strong:#5a40c8;
    --card:#ffffff;
    --muted:#6b6b80;
    --accent:#ffcc00;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg); color:#222;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    display:flex;flex-direction:column;
  }

  /* Header */
  header.appbar{
    background:linear-gradient(180deg,var(--primary),var(--primary-strong));
    color:white;padding:14px 16px;display:flex;align-items:center;gap:12px;
    position:sticky;top:0;z-index:50;box-shadow:0 6px 20px rgba(106,90,205,0.12);
  }
  header .brand{
    display:flex;align-items:center;gap:12px;
  }
  header img.logo{height:48px;object-fit:cover}
  header h1{font-size:18px;margin:0}
  header p.sub{margin:0;font-size:12px;opacity:0.95}

  .header-right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .account-btn{
    background:rgba(255,255,255,0.12);
    color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;
  }
  .account-menu{position:relative}
  .menu-popup{
    display:none;position:absolute;right:0;top:44px;background:white;color:#222;border-radius:10px;
    box-shadow:0 10px 30px rgba(10,10,40,0.12);overflow:hidden;min-width:180px;
  }
  .menu-popup button{display:block;width:100%;padding:10px;border:none;background:transparent;text-align:left;cursor:pointer}
  .menu-popup button:hover{background:#f6f6fb}

  main{padding:16px;flex:1;max-width:720px;margin:0 auto;width:100%}

  .controls{display:flex;gap:8px;justify-content:center;margin-top:12px;margin-bottom:16px}
  .btn{
    background:var(--card);border-radius:999px;padding:8px 12px;border:none;cursor:pointer;
    box-shadow:0 2px 6px rgba(15,15,30,0.04);font-weight:600;color:var(--primary);
  }
  .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;box-shadow:0 6px 18px rgba(90,64,200,0.16)}
  .small{padding:6px 10px;font-size:14px}

  .room-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .room-title h2{margin:0;font-size:18px}
  .fade-in{animation:fadeIn .35s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .card{
    background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:0 6px 18px rgba(22,22,45,0.05);
    cursor:pointer;display:flex;flex-direction:column;transition:transform .18s ease,box-shadow .18s;
  }
  .card:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(22,22,45,0.08)}
  .thumb{width:100%;height:120px;object-fit:cover;display:block}
  .card .meta{padding:10px}
  .card h3{margin:0;font-size:15px}
  .meta-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .muted{color:var(--muted);font-size:13px}

  .bottom-bar{position:sticky;bottom:12px;margin-top:18px}
  .collection{
    background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,0.98));
    border-radius:12px;padding:10px;box-shadow:0 8px 30px rgba(10,10,20,0.06);
  }
  .collection h4{margin:0 0 8px 0}
  .collection ul{margin:0;padding:0 12px;max-height:180px;overflow:auto}
  .collection li{list-style:none;padding:8px 0;border-bottom:1px dashed #efefef;font-size:14px}
  .icon-btn{background:transparent;border:none;cursor:pointer;padding:6px;border-radius:8px}
  .fav-active{color:var(--accent);filter:drop-shadow(0 2px 6px rgba(255,204,0,0.15))}

  .audio-overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(6,6,12,0.45);z-index:80;
  }
  .audio-card{background:white;padding:18px;border-radius:12px;text-align:center;width:90%;max-width:380px}
  .audio-card p{margin:8px 0 14px 0}
  .help{font-size:13px;color:#555;margin-top:8px}

  .stop-btn {
    position: fixed;
    right: 18px;
    bottom: 110px;
    background: #ff5c5c;
    color: white;
    border: none;
    padding: 10px 12px;
    border-radius: 999px;
    box-shadow: 0 8px 20px rgba(255,92,92,0.18);
    cursor: pointer;
    z-index: 90;
    display: none;
  }

  .login-modal {
    position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:200;
    background: linear-gradient(rgba(5,5,8,0.45), rgba(5,5,8,0.45));
  }
  .login-card {
    width:92%; max-width:400px; background:white; border-radius:14px; padding:18px; box-shadow:0 20px 50px rgba(10,10,40,0.25);
    transform: translateY(6px); animation:cardIn .28s cubic-bezier(.2,.9,.2,1) both;
  }
  @keyframes cardIn { from {opacity:0; transform: translateY(16px) scale(.99)} to {opacity:1; transform:none} }

  .login-card h3{margin:0 0 10px 0}
  .login-row{display:flex;gap:8px;margin-top:8px}
  .login-input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6ee}
  .login-actions{display:flex;gap:8px;margin-top:12px}
  .ghost{background:transparent;border:1px solid #ddd;padding:9px;border-radius:10px;cursor:pointer}
  .primary{background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;padding:9px;border-radius:10px;border:none;cursor:pointer;width:100%}

  @media (max-width:520px){
    .grid{grid-template-columns:1fr}
    header h1{font-size:16px}
    header img.logo{height:44px}
  }

  .collection.locked{filter:blur(2px) grayscale(.2);opacity:.9;pointer-events:none}
  .collection-cta{display:flex;gap:8px;align-items:center;margin-top:8px}
</style>
</head>
<body>

<header class="appbar">
  <div class="brand">
    <img class="logo" src="assets/LogoAB.png" alt="Logo Apollo Beats" onerror="this.style.opacity=0.6">
    <div>
      <h1>Apollo Beats</h1>
      <p class="sub">Prototype — visite guidée intelligente</p>
    </div>
  </div>

  <div class="header-right">
    <button class="btn small" id="simulateBtn" title="Simuler détection Wi-Fi">Simuler Wi-Fi</button>
    <button class="btn small" id="openCollectionBtn" title="Voir ma collection">Collection</button>
    <div class="account-menu">
      <button id="accountBtn" class="account-btn">Connexion</button>
      <div id="menuPopup" class="menu-popup" role="menu" aria-hidden="true"></div>
    </div>
  </div>
</header>

<main>
  <div id="status" style="text-align:center;margin-top:12px;color:#333;font-size:14px">En attente de détection Wi-Fi…</div>

  <button id="stop" onclick="stopCurrentAudio()" style="
    margin-top:1rem;
    padding:0.5rem 1rem;
    background:#ff5c5c;
    color:white;
    border:none;
    border-radius:5px;
    cursor:pointer;
    display:none;
  ">Arrêter l'audio</button>

  <div class="room-title fade-in" id="roomTitle" style="display:none">
    <h2 id="roomName">Salle</h2>
    <div id="roomStats" class="muted">0 œuvres</div>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>

  <div class="bottom-bar">
    <div id="collectionBox" class="collection">
      <h4>Ma collection (favoris + consultées)</h4>
      <div id="collectionInfo" style="margin:8px 0;color:var(--muted)"></div>
      <ul id="collectionList"></ul>
      <div id="collectionCTA" class="collection-cta" style="display:none">
        <div style="color:var(--muted)">Connecte-toi pour sauvegarder et retrouver ta collection sur ton compte.</div>
        <button id="ctaLogin" class="btn primary" style="margin-left:auto">Connexion</button>
      </div>
    </div>
  </div>
</main>

<button id="stopBtn" class="stop-btn" title="Arrêter l'audio" onclick="stopCurrentAudio()">■ Stop</button>

<div id="audioOverlay" class="audio-overlay" style="display:none">
  <div class="audio-card">
    <h3>Activer le son</h3>
    <p>Pour tester la lecture audio automatique dans le prototype, merci de cliquer pour autoriser le son.</p>
    <button id="enableSound" class="btn primary">Activer le son</button>
    <div class="help">(Autorisation nécessaire une seule fois par session)</div>
  </div>
</div>

<div id="loginModal" class="login-modal" aria-hidden="true">
  <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <h3 id="loginTitle">Se connecter / Créer un compte</h3>
    <input id="loginEmail" class="login-input" type="email" placeholder="Email">
    <input id="loginPassword" class="login-input" type="password" placeholder="Mot de passe">
    <div class="login-actions">
      <button id="loginSubmit" class="primary">Se connecter</button>
      <button id="registerSubmit" class="ghost">Créer un compte</button>
    </div>
    <div style="margin-top:10px;text-align:right;">
      <button id="closeLogin" class="ghost">Fermer</button>
    </div>
  </div>
</div>

<script>
/* ---------- Rooms data ---------- */
const ROOMS = {
  impressionnisme: {
    id: 'impressionnisme',
    name: 'Salle Impressionnisme',
    artworks: [
      { id:'renoir', title:'Bal du Moulin de la Galette — Renoir', img:'https://upload.wikimedia.org/wikipedia/commons/6/6e/Pierre-Auguste_Renoir_-_Bal_du_moulin_de_la_galette.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
      { id:'monet', title:'Impression, Soleil Levant — Monet', img:'https://upload.wikimedia.org/wikipedia/commons/4/44/Claude_Monet%2C_Impression%2C_soleil_levant.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
      { id:'manet', title:'Olympia — Manet', img:'https://upload.wikimedia.org/wikipedia/commons/9/9e/Edouard_Manet_-_Olympia_-_Google_Art_Project_2.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3' }
    ]
  },
  modernisme: {
    id: 'modernisme',
    name: 'Salle Modernisme',
    artworks: [
      { id:'picasso', title:"Les Demoiselles d'Avignon — Picasso", img:'https://upload.wikimedia.org/wikipedia/en/d/d7/Les_Demoiselles_d%27Avignon.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
      { id:'delaunay', title:'Carré — Robert Delaunay', img:'https://upload.wikimedia.org/wikipedia/commons/5/5a/Robert_Delaunay%2C_1912-13%2C_Carr%C3%A9_1912-13.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' },
      { id:'kandinsky', title:'Composition VIII — Kandinsky', img:'https://upload.wikimedia.org/wikipedia/commons/6/6e/Kandinsky_-_Composition_8.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' }
    ]
  },
  sculpture: {
    id:'sculpture',
    name:'Salle Sculpture & Photo',
    artworks:[
      { id:'rodin', title:'Le Penseur — Rodin', img:'https://upload.wikimedia.org/wikipedia/commons/8/83/Le_Penseur_Rodin.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' },
      { id:'man_ray', title:'Noir et Blanc — Man Ray', img:'https://upload.wikimedia.org/wikipedia/commons/3/34/Man_Ray_%281885-1976%29_-_Flatiron_Building%2C_New_York%2C_1928.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3' },
      { id:'brancusi', title:'Le Baiser — Brancusi', img:'https://upload.wikimedia.org/wikipedia/commons/0/02/Brancusi_Baiser.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3' }
    ]
  }
};

/* ---------- State ---------- */
let currentRoom = null;
let currentAudio = null;
let transitionAllowed = false;
let guestFavorites = new Set(JSON.parse(localStorage.getItem('ab_favs')||'[]'));
let guestVisited = new Set(JSON.parse(localStorage.getItem('ab_visited')||'[]'));
let USERS = JSON.parse(localStorage.getItem('ab_users') || '{}');
let currentUser = localStorage.getItem('ab_current') || null;

/* ---------- DOM refs ---------- */
const grid = document.getElementById('grid');
const roomName = document.getElementById('roomName');
const roomStats = document.getElementById('roomStats');
const status = document.getElementById('status');
const roomTitle = document.getElementById('roomTitle');
const collectionList = document.getElementById('collectionList');
const simulateBtn = document.getElementById('simulateBtn');
const audioOverlay = document.getElementById('audioOverlay');
const enableSoundBtn = document.getElementById('enableSound');
const openCollectionBtn = document.getElementById('openCollectionBtn');
const stopBtn = document.getElementById('stopBtn');

const accountBtn = document.getElementById('accountBtn');
const menuPopup = document.getElementById('menuPopup');
const loginModal = document.getElementById('loginModal');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginSubmit = document.getElementById('loginSubmit');
const registerSubmit = document.getElementById('registerSubmit');
const closeLogin = document.getElementById('closeLogin');
const collectionBox = document.getElementById('collectionBox');
const collectionInfo = document.getElementById('collectionInfo');
const collectionCTA = document.getElementById('collectionCTA');
const ctaLogin = document.getElementById('ctaLogin');

/* ---------- Helpers & Storage ---------- */
function persistUsers(){ localStorage.setItem('ab_users', JSON.stringify(USERS)); }
function setCurrentUser(email){
  currentUser = email;
  if(email) localStorage.setItem('ab_current', email); else localStorage.removeItem('ab_current');
}
function persistGuest(){ 
  localStorage.setItem('ab_favs', JSON.stringify(Array.from(guestFavorites))); 
  localStorage.setItem('ab_visited', JSON.stringify(Array.from(guestVisited)));
}
function isValidEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

/* ---------- Rendering ---------- */
function renderRoom(room){
  if(!room) return;
  currentRoom = room;
  roomTitle.style.display='flex';
  roomName.textContent = room.name;
  roomStats.textContent = room.artworks.length + ' œuvres';
  grid.innerHTML='';
  room.artworks.forEach(a=>{
    const div = document.createElement('div'); div.className='card fade-in';
    div.innerHTML = `
      <img src="${a.img}" class="thumb" alt="${a.title}">
      <div class="meta">
        <h3>${a.title}</h3>
        <div class="meta-row">
          <span class="muted">${a.id}</span>
          <button class="icon-btn ${guestFavorites.has(a.id)?'fav-active':''}" title="Favoris">★</button>
        </div>
      </div>`;
    const favBtn = div.querySelector('.icon-btn');
    favBtn.addEventListener('click', e=>{
      if(guestFavorites.has(a.id)) guestFavorites.delete(a.id);
      else guestFavorites.add(a.id);
      favBtn.classList.toggle('fav-active');
      persistGuest();
      renderCollection();
    });
    div.addEventListener('click', ()=>{
      playAudio(a.audio);
      guestVisited.add(a.id);
      persistGuest();
      renderCollection();
    });
    grid.appendChild(div);
  });
}

/* ---------- Collection ---------- */
function renderCollection(){
  const combined = Array.from(new Set([...guestVisited,...guestFavorites]));
  collectionList.innerHTML='';
  if(combined.length===0){ collectionInfo.textContent='Pas encore d’œuvres consultées ou ajoutées.'; }
  else{
    combined.forEach(id=>{
      const li = document.createElement('li'); li.textContent = id; collectionList.appendChild(li);
    });
    collectionInfo.textContent=`Total: ${combined.length} œuvres`;
  }
  if(currentUser) collectionBox.classList.remove('locked'), collectionCTA.style.display='none';
  else collectionBox.classList.add('locked'), collectionCTA.style.display='flex';
}

/* ---------- Audio ---------- */
function playAudio(url){
  stopCurrentAudio();
  currentAudio = new Audio(url); currentAudio.play();
  stopBtn.style.display='block';
}
function stopCurrentAudio(){
  if(currentAudio){ currentAudio.pause(); currentAudio=null; stopBtn.style.display='none'; }
}

/* ---------- Simulate Detection ---------- */
simulateBtn.addEventListener('click', ()=>{
  const keys = Object.keys(ROOMS);
  const r = ROOMS[keys[Math.floor(Math.random()*keys.length)]];
  renderRoom(r);
  status.textContent = 'Wi-Fi détecté dans ' + r.name;
});

/* ---------- Audio overlay ---------- */
enableSoundBtn.addEventListener('click', ()=>{
  audioOverlay.style.display='none';
});

/* ---------- Account menu ---------- */
accountBtn.addEventListener('click', ()=>{
  if(menuPopup.style.display==='block'){ menuPopup.style.display='none'; menuPopup.setAttribute('aria-hidden','true'); }
  else{
    menuPopup.innerHTML='';
    if(currentUser){
      const span = document.createElement('div'); span.textContent = currentUser; span.style.padding='10px'; menuPopup.appendChild(span);
      const logoutBtn = document.createElement('button'); logoutBtn.textContent='Déconnexion';
      logoutBtn.addEventListener('click', ()=>{ setCurrentUser(null); menuPopup.style.display='none'; renderCollection(); accountBtn.textContent='Connexion'; });
      menuPopup.appendChild(logoutBtn);
    } else {
      const loginBtn = document.createElement('button'); loginBtn.textContent='Connexion / Créer';
      loginBtn.addEventListener('click', ()=>{
        loginModal.style.display='flex';
        loginModal.setAttribute('aria-hidden','false');
      });
      menuPopup.appendChild(loginBtn);
    }
    menuPopup.style.display='block'; menuPopup.setAttribute('aria-hidden','false');
  }
});

/* ---------- Login Modal ---------- */
loginSubmit.addEventListener('click', ()=>{
  const email = (loginEmail.value||'').trim().toLowerCase();
  const pass = (loginPassword.value||'').trim();
  if(!email||!pass){ alert('Email et mot de passe requis'); return; }
  if(!isValidEmail(email)){ alert('Email invalide'); return; }
  if(!USERS[email]){ alert('Compte introuvable. Créez un compte.'); return; }
  if(USERS[email].password!==pass){ alert('Mot de passe incorrect'); return; }

  setCurrentUser(email); loginModal.style.display='none'; loginModal.setAttribute('aria-hidden','true');
  accountBtn.textContent = currentUser;
  USERS[email].favorites = USERS[email].favorites||[];
  USERS[email].visited = USERS[email].visited||[];
  renderCollection();
  alert('Connecté en tant que '+email);
});

registerSubmit.addEventListener('click', ()=>{
  const email = (loginEmail.value||'').trim().toLowerCase();
  const pass = (loginPassword.value||'').trim();
  if(!email||!pass){ alert('Email et mot de passe requis'); return; }
  if(!isValidEmail(email)){ alert('Email invalide'); return; }
  if(USERS[email]){ alert('Ce compte existe déjà'); return; }

  USERS[email]={password:pass,favorites:Array.from(guestFavorites),visited:Array.from(guestVisited)};
  persistUsers();
  setCurrentUser(email);
  loginModal.style.display='none'; loginModal.setAttribute('aria-hidden','true');
  accountBtn.textContent = currentUser;
  renderCollection();
  alert('Compte créé et connecté : '+email);
});

closeLogin.addEventListener('click', ()=>{
  loginModal.style.display='none';
  loginModal.setAttribute('aria-hidden','true');
});

ctaLogin.addEventListener('click', ()=>{
  loginModal.style.display='flex';
  loginModal.setAttribute('aria-hidden','false');
});

/* ---------- Init ---------- */
renderCollection();
</script>

</body>
</html>
