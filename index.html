<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apollo Beats — Prototype SPA</title>
<style>
  :root{
    --bg:#f6f7fb;
    --primary:#6a5acd;
    --primary-strong:#5a40c8;
    --card:#ffffff;
    --muted:#6b6b80;
    --accent:#ffcc00;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg); color:#222;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    display:flex;flex-direction:column;
  }

  /* Header */
  header.appbar{
    background:linear-gradient(180deg,var(--primary),var(--primary-strong));
    color:white;padding:14px 16px;display:flex;align-items:center;gap:12px;
    position:sticky;top:0;z-index:50;box-shadow:0 6px 20px rgba(106,90,205,0.12);
  }
  header .brand{
    display:flex;align-items:center;gap:12px;
  }
  header img.logo{height:48px;object-fit:cover}
  header h1{font-size:18px;margin:0}
  header p.sub{margin:0;font-size:12px;opacity:0.95}

  /* header right group */
  .header-right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .account-btn{
    background:rgba(255,255,255,0.12);
    color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;
  }
  .account-menu{position:relative}
  .menu-popup{
    display:none;position:absolute;right:0;top:44px;background:white;color:#222;border-radius:10px;
    box-shadow:0 10px 30px rgba(10,10,40,0.12);overflow:hidden;min-width:180px;
  }
  .menu-popup button{display:block;width:100%;padding:10px;border:none;background:transparent;text-align:left;cursor:pointer}
  .menu-popup button:hover{background:#f6f6fb}

  main{padding:16px;flex:1;max-width:720px;margin:0 auto;width:100%}

  /* controls */
  .controls{display:flex;gap:8px;justify-content:center;margin-top:12px;margin-bottom:16px}
  .btn{
    background:var(--card);border-radius:999px;padding:8px 12px;border:none;cursor:pointer;
    box-shadow:0 2px 6px rgba(15,15,30,0.04);font-weight:600;color:var(--primary);
  }
  .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;box-shadow:0 6px 18px rgba(90,64,200,0.16)}
  .small{padding:6px 10px;font-size:14px}

  /* current room title + animation */
  .room-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .room-title h2{margin:0;font-size:18px}
  .fade-in{animation:fadeIn .35s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  /* grid of artworks */
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .card{
    background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:0 6px 18px rgba(22,22,45,0.05);
    cursor:pointer;display:flex;flex-direction:column;transition:transform .18s ease,box-shadow .18s;
  }
  .card:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(22,22,45,0.08)}
  .thumb{width:100%;height:120px;object-fit:cover;display:block}
  .card .meta{padding:10px}
  .card h3{margin:0;font-size:15px}
  .meta-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .muted{color:var(--muted);font-size:13px}

  /* bottom area */
  .bottom-bar{position:sticky;bottom:12px;margin-top:18px}
  .collection{
    background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,0.98));
    border-radius:12px;padding:10px;box-shadow:0 8px 30px rgba(10,10,20,0.06);
  }
  .collection h4{margin:0 0 8px 0}
  .collection ul{margin:0;padding:0 12px;max-height:180px;overflow:auto}
  .collection li{list-style:none;padding:8px 0;border-bottom:1px dashed #efefef;font-size:14px}

  /* icons buttons */
  .icon-btn{background:transparent;border:none;cursor:pointer;padding:6px;border-radius:8px}
  .fav-active{color:var(--accent);filter:drop-shadow(0 2px 6px rgba(255,204,0,0.15))}

  /* overlay audio permission */
  .audio-overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(6,6,12,0.45);z-index:80;
  }
  .audio-card{background:white;padding:18px;border-radius:12px;text-align:center;width:90%;max-width:380px}
  .audio-card p{margin:8px 0 14px 0}
  .help{font-size:13px;color:#555;margin-top:8px}

  /* stop button style */
  .stop-btn {
    position: fixed;
    right: 18px;
    bottom: 110px;
    background: #ff5c5c;
    color: white;
    border: none;
    padding: 10px 12px;
    border-radius: 999px;
    box-shadow: 0 8px 20px rgba(255,92,92,0.18);
    cursor: pointer;
    z-index: 90;
    display: none;
  }

  /* modern login modal (option 2) */
  .login-modal {
    position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:200;
    background: linear-gradient(rgba(5,5,8,0.45), rgba(5,5,8,0.45));
  }
  .login-card {
    width:92%; max-width:400px; background:white; border-radius:14px; padding:18px; box-shadow:0 20px 50px rgba(10,10,40,0.25);
    transform: translateY(6px); animation:cardIn .28s cubic-bezier(.2,.9,.2,1) both;
  }
  @keyframes cardIn { from {opacity:0; transform: translateY(16px) scale(.99)} to {opacity:1; transform:none} }

  .login-card h3{margin:0 0 10px 0}
  .login-row{display:flex;gap:8px;margin-top:8px}
  .login-input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6ee}
  .login-actions{display:flex;gap:8px;margin-top:12px}
  .ghost{background:transparent;border:1px solid #ddd;padding:9px;border-radius:10px;cursor:pointer}
  .primary{background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;padding:9px;border-radius:10px;border:none;cursor:pointer;width:100%}

  /* responsive tweaks */
  @media (max-width:520px){
    .grid{grid-template-columns:1fr}
    header h1{font-size:16px}
    header img.logo{height:44px}
  }

  /* small helper: blurred collection when not connected */
  .collection.locked{filter:blur(2px) grayscale(.2);opacity:.9;pointer-events:none}
  .collection-cta{display:flex;gap:8px;align-items:center;margin-top:8px}
</style>
</head>
<body>

<header class="appbar">
  <div class="brand">
    <img class="logo" src="assets/LogoAB.png" alt="Logo Apollo Beats" onerror="this.style.opacity=0.6">
    <div>
      <h1>Apollo Beats</h1>
      <p class="sub">Prototype — visite guidée intelligente</p>
    </div>
  </div>

  <!-- right controls -->
  <div class="header-right">
    <button class="btn small" id="simulateBtn" title="Simuler détection Wi-Fi">Simuler Wi-Fi</button>
    <button class="btn small" id="openCollectionBtn" title="Voir ma collection">Collection</button>

    <!-- Connexion / Compte -->
    <div class="account-menu">
      <button id="accountBtn" class="account-btn">Connexion</button>
      <div id="menuPopup" class="menu-popup" role="menu" aria-hidden="true">
        <!-- content injected dynamically -->
      </div>
    </div>
  </div>
</header>

<main>
  <!-- automatic detection message -->
  <div id="status" style="text-align:center;margin-top:12px;color:#333;font-size:14px">En attente de détection Wi-Fi…</div>

  <!-- stop button (legacy) -->
  <button id="stop" onclick="stopAudio()" style="
    margin-top:1rem;
    padding:0.5rem 1rem;
    background:#ff5c5c;
    color:white;
    border:none;
    border-radius:5px;
    cursor:pointer;
    display:none;
  ">Arrêter l'audio</button>

  <!-- room title -->
  <div class="room-title fade-in" id="roomTitle" style="display:none">
    <h2 id="roomName">Salle</h2>
    <div id="roomStats" class="muted">0 œuvres</div>
  </div>

  <!-- artworks -->
  <div id="grid" class="grid" aria-live="polite"></div>

  <!-- bottom collection -->
  <div class="bottom-bar">
    <div id="collectionBox" class="collection">
      <h4>Ma collection (favoris + consultées)</h4>
      <div id="collectionInfo" style="margin:8px 0;color:var(--muted)"></div>
      <ul id="collectionList"></ul>
      <div id="collectionCTA" class="collection-cta" style="display:none">
        <div style="color:var(--muted)">Connecte-toi pour sauvegarder et retrouver ta collection sur ton compte.</div>
        <button id="ctaLogin" class="btn primary" style="margin-left:auto">Connexion</button>
      </div>
    </div>
  </div>
</main>

<!-- STOP floating button -->
<button id="stopBtn" class="stop-btn" title="Arrêter l'audio" onclick="stopCurrentAudio()">■ Stop</button>

<!-- Audio permission overlay (browser autoplay policy) -->
<div id="audioOverlay" class="audio-overlay" style="display:none">
  <div class="audio-card">
    <h3>Activer le son</h3>
    <p>Pour tester la lecture audio automatique dans le prototype, merci de cliquer pour autoriser le son.</p>
    <button id="enableSound" class="btn primary">Activer le son</button>
    <div class="help">(Autorisation nécessaire une seule fois par session)</div>
  </div>
</div>

<!-- Login modal (modern style) -->
<div id="loginModal" class="login-modal" aria-hidden="true">
  <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <h3 id="loginTitle">Se connecter / Créer un compte</h3>
    <input id="loginEmail" class="login-input" type="email" placeholder="Email">
    <input id="loginPassword" class="login-input" type="password" placeholder="Mot de passe">
    <div class="login-actions">
      <button id="loginSubmit" class="primary">Se connecter</button>
      <button id="registerSubmit" class="ghost">Créer un compte</button>
    </div>
    <div style="margin-top:10px;text-align:right;">
      <button id="closeLogin" class="ghost">Fermer</button>
    </div>
  </div>
</div>

<script>
/* ---------- Keep your original ROOMS and functionality, extend with login ---------- */
const ROOMS = {
  impressionnisme: {
    id: 'impressionnisme',
    name: 'Salle Impressionnisme',
    artworks: [
      { id:'renoir', title:'Bal du Moulin de la Galette — Renoir', img:'https://upload.wikimedia.org/wikipedia/commons/6/6e/Pierre-Auguste_Renoir_-_Bal_du_moulin_de_la_galette.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
      { id:'monet', title:'Impression, Soleil Levant — Monet', img:'https://upload.wikimedia.org/wikipedia/commons/4/44/Claude_Monet%2C_Impression%2C_soleil_levant.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
      { id:'manet', title:'Olympia — Manet', img:'https://upload.wikimedia.org/wikipedia/commons/9/9e/Edouard_Manet_-_Olympia_-_Google_Art_Project_2.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3' }
    ]
  },
  modernisme: {
    id: 'modernisme',
    name: 'Salle Modernisme',
    artworks: [
      { id:'picasso', title:"Les Demoiselles d'Avignon — Picasso", img:'https://upload.wikimedia.org/wikipedia/en/d/d7/Les_Demoiselles_d%27Avignon.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
      { id:'delaunay', title:'Carré — Robert Delaunay', img:'https://upload.wikimedia.org/wikipedia/commons/5/5a/Robert_Delaunay%2C_1912-13%2C_Carr%C3%A9_1912-13.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' },
      { id:'kandinsky', title:'Composition VIII — Kandinsky', img:'https://upload.wikimedia.org/wikipedia/commons/6/6e/Kandinsky_-_Composition_8.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' }
    ]
  },
  sculpture: {
    id:'sculpture',
    name:'Salle Sculpture & Photo',
    artworks:[
      { id:'rodin', title:'Le Penseur — Rodin', img:'https://upload.wikimedia.org/wikipedia/commons/8/83/Le_Penseur_Rodin.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' },
      { id:'man_ray', title:'Noir et Blanc — Man Ray', img:'https://upload.wikimedia.org/wikipedia/commons/3/34/Man_Ray_%281885-1976%29_-_Flatiron_Building%2C_New_York%2C_1928.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3' },
      { id:'brancusi', title:'Le Baiser — Brancusi', img:'https://upload.wikimedia.org/wikipedia/commons/0/02/Brancusi_Baiser.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3' }
    ]
  }
};

/* ---------- State ---------- */
let currentRoom = null;
let currentAudio = null;        // HTMLAudioElement for artwork playback
let transitionAllowed = false;  // set after user enables audio overlay

// local guest sets (used when not logged)
let guestFavorites = new Set(JSON.parse(localStorage.getItem('ab_favs')||'[]'));
let guestVisited = new Set(JSON.parse(localStorage.getItem('ab_visited')||'[]'));

// users stored in localStorage under key 'ab_users'
// structure: { "email@example.com": { password: "...", favorites: [...], visited: [...] } }
let USERS = JSON.parse(localStorage.getItem('ab_users') || '{}');
let currentUser = localStorage.getItem('ab_current') || null; // email or null

/* ---------- DOM refs ---------- */
const grid = document.getElementById('grid');
const roomName = document.getElementById('roomName');
const roomStats = document.getElementById('roomStats');
const status = document.getElementById('status');
const roomTitle = document.getElementById('roomTitle');
const collectionList = document.getElementById('collectionList');
const simulateBtn = document.getElementById('simulateBtn');
const audioOverlay = document.getElementById('audioOverlay');
const enableSoundBtn = document.getElementById('enableSound');
const openCollectionBtn = document.getElementById('openCollectionBtn');
const stopBtn = document.getElementById('stopBtn');

const accountBtn = document.getElementById('accountBtn');
const menuPopup = document.getElementById('menuPopup');

const loginModal = document.getElementById('loginModal');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginSubmit = document.getElementById('loginSubmit');
const registerSubmit = document.getElementById('registerSubmit');
const closeLogin = document.getElementById('closeLogin');
const collectionBox = document.getElementById('collectionBox');
const collectionInfo = document.getElementById('collectionInfo');
const collectionCTA = document.getElementById('collectionCTA');
const ctaLogin = document.getElementById('ctaLogin');

/* ---------- Helpers: storage & users ---------- */
function persistUsers(){ localStorage.setItem('ab_users', JSON.stringify(USERS)); }
function setCurrentUser(email){
  currentUser = email;
  if(email) localStorage.setItem('ab_current', email);
  else localStorage.removeItem('ab_current');
  updateAccountUI();
  renderCollection();
}

/* get favorites for active context (user if logged, else guest) */
function getFavoritesSet(){
  if(currentUser && USERS[currentUser]) return new Set(USERS[currentUser].favorites || []);
  return new Set(Array.from(guestFavorites));
}
function getVisitedSet(){
  if(currentUser && USERS[currentUser]) return new Set(USERS[currentUser].visited || []);
  return new Set(Array.from(guestVisited));
}

/* save favorites/visited back to storage for current context */
function saveFavoritesSet(set){
  if(currentUser && USERS[currentUser]){ USERS[currentUser].favorites = Array.from(set); persistUsers(); }
  else { guestFavorites = new Set(Array.from(set)); localStorage.setItem('ab_favs', JSON.stringify(Array.from(guestFavorites))); }
}
function saveVisitedSet(set){
  if(currentUser && USERS[currentUser]){ USERS[currentUser].visited = Array.from(set); persistUsers(); }
  else { guestVisited = new Set(Array.from(set)); localStorage.setItem('ab_visited', JSON.stringify(Array.from(guestVisited))); }
}

/* ---------- Helpers: misc ---------- */
function playTransitionTone(duration=120, freq=880, vol=0.15){
  if(!transitionAllowed) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine'; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, duration);
  }catch(e){ console.warn('WebAudio not available', e) }
}

/* ---------- UI rendering (artworks) ---------- */
function renderRoom(room){
  currentRoom = room;
  playTransitionTone(); // fx when arriving in a room
  roomName.textContent = room.name;
  roomStats.textContent = `${room.artworks.length} œuvres`;
  roomTitle.style.display = 'flex';
  status.style.display = 'none';
  grid.innerHTML = '';

  const favSet = getFavoritesSet();

  room.artworks.forEach(art => {
    const card = document.createElement('div');
    card.className = 'card fade-in';
    card.setAttribute('role','button');
    card.setAttribute('tabindex','0');

    // card inner html
    card.innerHTML = `
      <img class="thumb" src="${art.img}" alt="${escapeHtml(art.title)}">
      <div class="meta">
        <h3>${escapeHtml(art.title)}</h3>
        <div class="meta-row">
          <div class="muted">Cliquer pour écouter</div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="icon-btn" title="Favoris" data-art="${art.id}" aria-label="Favoris">
              ${favSet.has(art.id) ? starSvg(true) : starSvg(false)}
            </button>
            <button class="icon-btn" title="Écouter" data-play="${art.id}" aria-label="Écouter">
              ${playSvg()}
            </button>
          </div>
        </div>
      </div>
    `;

    // click card or Play button -> play
    card.addEventListener('click', (e)=>{
      const favBtn = e.target.closest('button[data-art]');
      const playBtn = e.target.closest('button[data-play]');
      if(favBtn){ toggleFav(favBtn.getAttribute('data-art')); e.stopPropagation(); return; }
      if(playBtn){ playArtworkById(playBtn.getAttribute('data-play')); e.stopPropagation(); return; }
      playArtworkById(art.id);
    });

    // keyboard accessibility: enter/space to play
    card.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); playArtworkById(art.id); }
    });

    grid.appendChild(card);
  });
}

/* escape helper to avoid naive html injection */
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

/* ---------- Audio management ---------- */
function stopCurrentAudio(){
  if(currentAudio){
    try{
      currentAudio.pause();
      currentAudio.currentTime = 0;
    }catch(e){}
    currentAudio = null;
  }
  // hide stop button
  stopBtn.style.display = 'none';
  // legacy stop button
  const stopLegacy = document.getElementById('stop');
  if(stopLegacy) stopLegacy.style.display = 'none';
}

/* Play artwork by id (stops previous audio automatically) */
function playArtworkById(id){
  const art = findArtwork(id);
  if(!art) return;
  // if not allowed yet, show overlay for user to enable sound
  if(!transitionAllowed){
    showAudioOverlay();
    return;
  }

  // play small transition tone
  playTransitionTone(90,1200,0.08);

  // stop old audio
  stopCurrentAudio();

  // create new audio and play
  currentAudio = new Audio(art.audio);
  currentAudio.preload = 'auto';
  currentAudio.addEventListener('canplaythrough', ()=>{ 
    currentAudio.play().catch(()=>{/* autoplay blocked */}); 
  });
  currentAudio.addEventListener('ended', ()=>{ 
    currentAudio = null; 
    stopBtn.style.display = 'none';
    const stopLegacy = document.getElementById('stop');
    if(stopLegacy) stopLegacy.style.display = 'none';
  });

  // show stop button
  stopBtn.style.display = 'block';
  const stopLegacy = document.getElementById('stop');
  if(stopLegacy) stopLegacy.style.display = 'inline-block';

  // mark visited & update UI (store into correct user or guest)
  const visitedSet = getVisitedSet();
  visitedSet.add(art.id);
  saveVisitedSet(visitedSet);
  renderCollection();

  flashArtworkCard(id);
}

/* find art in ROOMS */
function findArtwork(id){
  for(const r of Object.values(ROOMS)){
    for(const a of r.artworks) if(a.id === id) return a;
  }
  return null;
}

/* flash card */
function flashArtworkCard(id){
  const btns = [...document.querySelectorAll(`[data-play="${id}"]`)];
  if(btns.length>0){
    const card = btns[0].closest('.card');
    card.style.transition = 'transform .12s';
    card.style.transform = 'scale(1.02)';
    setTimeout(()=>{ card.style.transform = ''; }, 260);
  }
}

/* ---------- Favorites & Collection (per-user) ---------- */
function toggleFav(id){
  const favSet = getFavoritesSet();
  if(favSet.has(id)) favSet.delete(id); else favSet.add(id);
  // save back
  saveFavoritesSet(favSet);
  renderRoom(currentRoom);
  renderCollection();
}

/* render collection list (favorites first) */
function renderCollection(){
  collectionList.innerHTML = '';
  const favSet = getFavoritesSet();
  const visitedSet = getVisitedSet();

  // update collection box UI depending on login
  if(!currentUser){
    collectionBox.classList.add('locked');
    collectionInfo.textContent = "Connecte-toi pour sauvegarder et retrouver ta collection.";
    collectionCTA.style.display = 'flex';
  } else {
    collectionBox.classList.remove('locked');
    collectionInfo.textContent = `Connecté en tant que ${currentUser}`;
    collectionCTA.style.display = 'none';
  }

  // favorites
  if(favSet.size>0){
    const favHeader = document.createElement('li'); favHeader.textContent = 'Favoris'; favHeader.style.fontWeight='700';
    collectionList.appendChild(favHeader);
    for(const id of favSet){
      const art = findArtwork(id);
      if(!art) continue;
      const li = document.createElement('li');
      li.innerHTML = `${escapeHtml(art.title)} <button class="btn small" style="float:right" onclick="playArtworkById('${art.id}')">Écouter</button>`;
      collectionList.appendChild(li);
    }
  }
  // visited (but not in favorites)
  const otherVisited = [...visitedSet].filter(id=>!favSet.has(id));
  if(otherVisited.length>0){
    const header = document.createElement('li'); header.textContent = 'Consultées'; header.style.fontWeight='700'; header.style.marginTop='8px';
    collectionList.appendChild(header);
    otherVisited.forEach(id=>{
      const art = findArtwork(id);
      if(!art) return;
      const li = document.createElement('li');
      li.innerHTML = `${escapeHtml(art.title)} <button class="btn small" style="float:right" onclick="playArtworkById('${art.id}')">Écouter</button>`;
      collectionList.appendChild(li);
    });
  }

  if(favSet.size===0 && otherVisited.length===0){
    const li = document.createElement('li'); li.textContent = 'Aucune œuvre pour le moment. Cliquez sur une œuvre pour l’écouter.'; collectionList.appendChild(li);
  }
}

/* save helpers for favorites/visited */
function saveFavoritesSet(set){
  if(currentUser){
    if(!USERS[currentUser]) USERS[currentUser] = { password:'', favorites:[], visited:[] };
    USERS[currentUser].favorites = Array.from(set);
    persistUsers();
  } else {
    guestFavorites = new Set(Array.from(set));
    localStorage.setItem('ab_favs', JSON.stringify(Array.from(guestFavorites)));
  }
}
function saveVisitedSet(set){
  if(currentUser){
    if(!USERS[currentUser]) USERS[currentUser] = { password:'', favorites:[], visited:[] };
    USERS[currentUser].visited = Array.from(set);
    persistUsers();
  } else {
    guestVisited = new Set(Array.from(set));
    localStorage.setItem('ab_visited', JSON.stringify(Array.from(guestVisited)));
  }
}

/* ---------- Simulate Wi-Fi detection ---------- */
function simulateDetection(){
  status.textContent = 'Détection Wi-Fi en cours…';
  // small UX delay
  setTimeout(()=>{
    // pick a random room
    const keys = Object.keys(ROOMS);
    const choice = keys[Math.floor(Math.random()*keys.length)];
    renderRoom(ROOMS[choice]);
    // scroll to top to show room
    window.scrollTo({top:0,behavior:'smooth'});
  }, 700);
}

/* ---------- Overlay & initial activation ---------- */
function showAudioOverlay(){ audioOverlay.style.display='flex'; }
function hideAudioOverlay(){ audioOverlay.style.display='none'; }

/* ---------- Utility svg icons ---------- */
function starSvg(active=false){
  if(active){
    return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 17.3l-6.16 3.24 1.18-6.88L2.7 9.76l6.95-1.01L12 2.5l2.35 6.25 6.95 1.01-4.32 4.9 1.18 6.88z" fill="#FFCC00"/></svg>`;
  }
  return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 17.3l-6.16 3.24 1.18-6.88L2.7 9.76l6.95-1.01L12 2.5l2.35 6.25 6.95 1.01-4.32 4.9 1.18 6.88z" stroke="#bbb" stroke-width="1.2" fill="none"/></svg>`;
}
function playSvg(){
  return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M5 3v18l15-9z" fill="#6a5acd"/></svg>`;
}

/* ---------- Account / Login logic ---------- */
/* show account menu or login depending on state */
function updateAccountUI(){
  if(currentUser && USERS[currentUser]){
    accountBtn.textContent = currentUser;
    menuPopup.innerHTML = `
      <button onclick="viewProfile()">Mon compte</button>
      <button onclick="logout()">Se déconnecter</button>
    `;
    menuPopup.style.display = 'none';
    menuPopup.setAttribute('aria-hidden','true');
  } else {
    accountBtn.textContent = 'Connexion';
    menuPopup.innerHTML = `<button onclick="openLoginModal()">Se connecter / Créer un compte</button>`;
    menuPopup.style.display = 'none';
    menuPopup.setAttribute('aria-hidden','true');
  }
}

/* toggle menu */
accountBtn.addEventListener('click', ()=>{
  if(menuPopup.style.display === 'block'){ menuPopup.style.display = 'none'; menuPopup.setAttribute('aria-hidden','true'); }
  else { menuPopup.style.display = 'block'; menuPopup.setAttribute('aria-hidden','false'); }
});

/* open login modal */
function openLoginModal(){
  loginModal.style.display = 'flex';
  loginModal.setAttribute('aria-hidden','false');
  menuPopup.style.display = 'none';
  menuPopup.setAttribute('aria-hidden','true');
}

/* close login */
closeLogin.addEventListener('click', ()=>{
  loginModal.style.display = 'none';
  loginModal.setAttribute('aria-hidden','true');
});

/* login & register handlers */
loginSubmit.addEventListener('click', ()=>{
  const email = (loginEmail.value || '').trim().toLowerCase();
  const pass = (loginPassword.value || '').trim();
  if(!email || !pass){ alert('Email et mot de passe requis'); return; }
  if(!USERS[email]){ alert('Compte introuvable. Créez un compte.'); return; }
  if(USERS[email].password !== pass){ alert('Mot de passe incorrect'); return; }
  // successful login
  setCurrentUser(email);
  loginModal.style.display = 'none';
  loginModal.setAttribute('aria-hidden','true');
  // ensure sets exist
  USERS[email].favorites = USERS[email].favorites || [];
  USERS[email].visited = USERS[email].visited || [];
  persistUsers();
  renderRoom(currentRoom || ROOMS[Object.keys(ROOMS)[0]]);
  alert('Connecté en tant que ' + email);
});

registerSubmit.addEventListener('click', ()=>{
  const email = (loginEmail.value || '').trim().toLowerCase();
  const pass = (loginPassword.value || '').trim();
  if(!email || !pass){ alert('Email et mot de passe requis'); return; }
  if(USERS[email]){ alert('Ce compte existe déjà'); return; }
  USERS[email] = { password: pass, favorites: Array.from(guestFavorites), visited: Array.from(guestVisited) };
  persistUsers();
  setCurrentUser(email);
  loginModal.style.display = 'none';
  loginModal.setAttribute('aria-hidden','true');
  alert('Compte créé et connecté : ' + email);
});

/* view profile (simple) */
function viewProfile(){
  menuPopup.style.display = 'none';
  menuPopup.setAttribute('aria-hidden','true');
  alert('Profil: ' + currentUser + '\nFavoris: ' + JSON.stringify(USERS[currentUser].favorites || []) );
}

/* logout */
function logout(){
  setCurrentUser(null);
  alert('Déconnecté');
}

/* CTA login button in collection area */
ctaLogin.addEventListener('click', ()=>{
  openLoginModal();
});

/* ---------- keyboard + UI wiring ---------- */
simulateBtn.addEventListener('click', simulateDetection);
openCollectionBtn.addEventListener('click', ()=>{ window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); });

enableSoundBtn.addEventListener('click', ()=>{
  transitionAllowed = true;
  // play a tiny click to ensure audio context allowed
  playTransitionTone(80,1000,0.06);
  hideAudioOverlay();
});

/* On first load: show overlay so user can allow audio if they want automatic playback */
window.addEventListener('load', ()=>{
  audioOverlay.style.display = 'flex';
  // restore current user if any
  if(currentUser && !USERS[currentUser]){ currentUser = null; localStorage.removeItem('ab_current'); }
  updateAccountUI();
  renderCollection();
});

/* expose a couple helpers for buttons created dynamically */
window.playArtworkById = playArtworkById;
window.toggleFav = toggleFav;
window.stopCurrentAudio = stopCurrentAudio;

</script>
</body>
</html>

