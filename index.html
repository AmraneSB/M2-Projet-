<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apollo Beats â€” Prototype SPA</title>
<style>
  :root{
    --bg:#f6f7fb;
    --primary:#6a5acd;
    --primary-strong:#5a40c8;
    --card:#ffffff;
    --muted:#6b6b80;
    --accent:#ffcc00;
    --radius:12px;
  }

  /* Dark theme variables (manual toggle will add .dark on body) */
  body.dark{
    --bg:#0b0d12;
    --primary:#9aa3ff;
    --primary-strong:#7d6eff;
    --card:#0f1720;
    --muted:#98a0b3;
    --accent:#ffcf66;
  }

  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg); color:#222;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    display:flex;flex-direction:column;
  }

  /* Header */
  header.appbar{
    background:linear-gradient(180deg,var(--primary),var(--primary-strong));
    color:white;padding:14px 16px;display:flex;align-items:center;gap:12px;
    position:sticky;top:0;z-index:50;box-shadow:0 6px 20px rgba(106,90,205,0.12);
  }
  header .brand{display:flex;align-items:center;gap:12px;}
  header img.logo{height:48px;object-fit:cover}
  header h1{font-size:18px;margin:0}
  header p.sub{margin:0;font-size:12px;opacity:0.95}

  .header-right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .account-btn{background:rgba(255,255,255,0.12); color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;}
  .account-menu{position:relative}
  .menu-popup{display:none;position:absolute;right:0;top:44px;background:white;color:#222;border-radius:10px;box-shadow:0 10px 30px rgba(10,10,40,0.12);overflow:hidden;min-width:180px;}
  .menu-popup button{display:block;width:100%;padding:10px;border:none;background:transparent;text-align:left;cursor:pointer}
  .menu-popup button:hover{background:#f6f6fb}

  main{padding:16px;flex:1;max-width:720px;margin:0 auto;width:100%}

  /* controls */
  .controls{display:flex;gap:8px;justify-content:center;margin-top:12px;margin-bottom:16px}
  .btn{background:var(--card);border-radius:999px;padding:8px 12px;border:none;cursor:pointer;box-shadow:0 2px 6px rgba(15,15,30,0.04);font-weight:600;color:var(--primary);}
  .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;box-shadow:0 6px 18px rgba(90,64,200,0.16)}
  .small{padding:6px 10px;font-size:14px}

  /* current room title + animation */
  .room-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .room-title h2{margin:0;font-size:18px}
  .fade-in{animation:fadeIn .35s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  /* grid of artworks */
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .card{
    background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:0 6px 18px rgba(22,22,45,0.05);
    cursor:pointer;display:flex;flex-direction:column;transition:transform .18s ease,box-shadow .18s;
    position:relative;padding-bottom:6px;
  }
  .card.playing{box-shadow:0 14px 40px rgba(106,90,205,0.12); transform:translateY(-6px) scale(1.02);}
  .card .playing-badge{
    position:absolute;left:10px;top:10px;background:linear-gradient(90deg,var(--primary),var(--primary-strong));
    color:white;padding:6px 8px;border-radius:999px;font-size:12px;font-weight:700;
    box-shadow:0 6px 18px rgba(90,64,200,0.18);
  }
  .card .consulted {
    position:absolute; right:10px; top:10px; font-size:12px; font-weight:700; color:var(--accent);
    background: rgba(255,255,255,0.95); padding:4px 8px; border-radius:999px;
  }
  body.dark .card .consulted { background: rgba(0,0,0,0.25); color:var(--accent); }

  .card:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(22,22,45,0.08)}
  .thumb{width:100%;height:120px;object-fit:cover;display:block}
  .card .meta{padding:10px}
  .card h3{margin:0;font-size:15px}
  .meta-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .muted{color:var(--muted);font-size:13px}

  /* bottom area */
  .bottom-bar{position:sticky;bottom:12px;margin-top:18px}
  .collection{background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,0.98));border-radius:12px;padding:10px;box-shadow:0 8px 30px rgba(10,10,20,0.06);}
  .collection h4{margin:0 0 8px 0}
  .collection ul{margin:0;padding:0 12px;max-height:180px;overflow:auto}
  .collection li{list-style:none;padding:8px 0;border-bottom:1px dashed #efefef;font-size:14px}

  .icon-btn{background:transparent;border:none;cursor:pointer;padding:6px;border-radius:8px}
  .fav-active{color:var(--accent);filter:drop-shadow(0 2px 6px rgba(255,204,0,0.15))}

  .audio-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(6,6,12,0.45);z-index:80;}
  .audio-card{background:white;padding:18px;border-radius:12px;text-align:center;width:90%;max-width:380px}
  .audio-card p{margin:8px 0 14px 0}
  .help{font-size:13px;color:#555;margin-top:8px}

  .stop-btn {position: fixed; right: 18px; bottom: 110px; background: #ff5c5c; color: white; border: none; padding: 10px 12px; border-radius: 999px; box-shadow: 0 8px 20px rgba(255,92,92,0.18); cursor: pointer; z-index: 90; display: none;}

  .login-modal {position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:200; background: linear-gradient(rgba(5,5,8,0.45), rgba(5,5,8,0.45));}
  .login-card {width:92%; max-width:400px; background:white; border-radius:14px; padding:18px; box-shadow:0 20px 50px rgba(10,10,40,0.25); transform: translateY(6px); animation:cardIn .28s cubic-bezier(.2,.9,.2,1) both;}
  @keyframes cardIn { from {opacity:0; transform: translateY(16px) scale(.99)} to {opacity:1; transform:none} }
  .login-card h3{margin:0 0 10px 0}
  .login-row{display:flex;gap:8px;margin-top:8px}
  .login-input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6ee}
  .login-actions{display:flex;gap:8px;margin-top:12px}
  .ghost{background:transparent;border:1px solid #ddd;padding:9px;border-radius:10px;cursor:pointer}
  .primary{background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;padding:9px;border-radius:10px;border:none;cursor:pointer;width:100%}

  @media (max-width:520px){ .grid{grid-template-columns:1fr} header h1{font-size:16px} header img.logo{height:44px} }

  .collection.locked{filter:blur(2px) grayscale(.2);opacity:.9;pointer-events:none}
  .collection-cta{display:flex;gap:8px;align-items:center;margin-top:8px}

  /* small network status */
  #status small{display:block;color:var(--muted);font-size:12px;margin-top:6px}

  /* Option A controls */
  .wifi-sim { display:flex;gap:8px;align-items:center;justify-content:center;margin:12px 0; }
  .wifi-sim .dist { font-weight:700;color:var(--muted);padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.9); }
  .wifi-icon { font-size:18px; margin-left:8px; }

  /* audio progress */
  .audio-progress {
    position: fixed;
    left: 18px;
    right: 120px;
    bottom: 70px;
    height: 36px;
    display:flex;
    align-items:center;
    gap:8px;
    z-index: 90;
    background: rgba(255,255,255,0.95);
    padding:6px 10px;
    border-radius:999px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    display:none;
  }
  body.dark .audio-progress { background: rgba(255,255,255,0.04); box-shadow: 0 8px 24px rgba(0,0,0,0.45); color: #e6e6e9; }
  .audio-progress progress { width:100%; height:6px; appearance:none; -webkit-appearance:none; border-radius:6px; overflow:hidden; background:rgba(0,0,0,0.06); }
  .audio-progress progress::-webkit-progress-bar { background:transparent; }
  .audio-progress progress::-webkit-progress-value { background: linear-gradient(90deg,var(--primary),var(--primary-strong)); }
  .audio-progress .time { font-size:12px; color:var(--muted); min-width:48px; text-align:right; }

  /* small theme toggle */
  .theme-toggle { font-size:14px; }
</style>
</head>
<body>

<header class="appbar">
  <div class="brand">
    <img class="logo" src="assets/LogoAB.png" alt="Logo Apollo Beats" onerror="this.style.opacity=0.6">
    <div>
      <h1>Apollo Beats</h1>
      <p class="sub">Prototype â€” visite guidÃ©e intelligente</p>
    </div>
  </div>

  <div class="header-right">
    <button class="btn small" id="simulateBtn" title="Simuler dÃ©tection Wi-Fi">Simuler Wi-Fi</button>

    <!-- Theme toggle (manual as requested) -->
    <button class="btn small theme-toggle" id="themeToggle" title="Basculer thÃ¨me">ðŸŒ“</button>

    <!-- open collection -->
    <button class="btn small" id="openCollectionBtn" title="Voir ma collection">Collection</button>

    <div class="account-menu">
      <button id="accountBtn" class="account-btn">Connexion</button>
      <div id="menuPopup" class="menu-popup" role="menu" aria-hidden="true"></div>
    </div>
  </div>
</header>

<main>
  <div id="status" style="text-align:center;margin-top:12px;color:#333;font-size:14px">
    En attente de dÃ©tection Wi-Fiâ€¦
    <small id="networkDetails"></small>
  </div>

  <!-- Option A controls: forward/back + distance + icon -->
  <div class="wifi-sim" id="wifiSimControls" style="display:flex">
    <button id="btnBack" class="btn small" title="Reculer">â—€ Reculer</button>
    <div class="dist">Distance: <span id="simDistance">0</span> m</div>
    <button id="btnForward" class="btn small" title="Avancer">Avancer â–¶</button>
    <div class="wifi-icon" id="wifiIcon" aria-hidden>ðŸ“¶ðŸ“¶ðŸ“¶</div>
  </div>

  <button id="stop" onclick="stopAudio()" style="margin-top:1rem;padding:0.5rem 1rem;background:#ff5c5c;color:white;border:none;border-radius:5px;cursor:pointer;display:none;">ArrÃªter l'audio</button>

  <div class="room-title fade-in" id="roomTitle" style="display:none">
    <h2 id="roomName">Salle</h2>
    <div id="roomStats" class="muted">0 Å“uvres</div>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>

  <div class="bottom-bar">
    <div id="collectionBox" class="collection">
      <h4>Ma collection (favoris + consultÃ©es)</h4>
      <div id="collectionInfo" style="margin:8px 0;color:var(--muted)"></div>
      <ul id="collectionList"></ul>
      <div id="collectionCTA" class="collection-cta" style="display:none">
        <div style="color:var(--muted)">Connecte-toi pour sauvegarder et retrouver ta collection sur ton compte.</div>
        <button id="ctaLogin" class="btn primary" style="margin-left:auto">Connexion</button>
      </div>
    </div>
  </div>
</main>

<!-- Floating stop -->
<button id="stopBtn" class="stop-btn" title="ArrÃªter l'audio" onclick="stopCurrentAudio()">â–  Stop</button>

<!-- Audio progress -->
<div id="audioProgress" class="audio-progress">
  <div style="width:14px;">ðŸ”Š</div>
  <progress id="progressBar" value="0" max="100"></progress>
  <div class="time" id="progressTime">0:00</div>
</div>

<div id="audioOverlay" class="audio-overlay" style="display:none">
  <div class="audio-card">
    <h3>Activer le son</h3>
    <p>Pour tester la lecture audio automatique dans le prototype, merci de cliquer pour autoriser le son.</p>
    <button id="enableSound" class="btn primary">Activer le son</button>
    <div class="help">(Autorisation nÃ©cessaire une seule fois par session)</div>
  </div>
</div>

<div id="loginModal" class="login-modal" aria-hidden="true">
  <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <h3 id="loginTitle">Se connecter / CrÃ©er un compte</h3>
    <input id="loginEmail" class="login-input" type="email" placeholder="Email">
    <input id="loginPassword" class="login-input" type="password" placeholder="Mot de passe">
    <div class="login-actions">
      <button id="loginSubmit" class="primary">Se connecter</button>
      <button id="registerSubmit" class="ghost">CrÃ©er un compte</button>
    </div>
    <div style="margin-top:10px;text-align:right;">
      <button id="closeLogin" class="ghost">Fermer</button>
    </div>
  </div>
</div>

<script>
/* ---------- ROOMS & artworks ---------- */
const ROOMS = {
  impressionnisme: {
    id: 'impressionnisme',
    name: 'Salle Impressionnisme',
    artworks: [
      { id:'renoir', title:'Bal du Moulin de la Galette â€” Renoir', img:'https://upload.wikimedia.org/wikipedia/commons/6/6e/Pierre-Auguste_Renoir_-_Bal_du_moulin_de_la_galette.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
      { id:'monet', title:'Impression, Soleil Levant â€” Monet', img:'https://upload.wikimedia.org/wikipedia/commons/4/44/Claude_Monet%2C_Impression%2C_soleil_levant.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
      { id:'manet', title:'Olympia â€” Manet', img:'https://upload.wikimedia.org/wikipedia/commons/9/9e/Edouard_Manet_-_Olympia_-_Google_Art_Project_2.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3' }
    ]
  },
  modernisme: {
    id: 'modernisme',
    name: 'Salle Modernisme',
    artworks: [
      { id:'picasso', title:"Les Demoiselles d'Avignon â€” Picasso", img:'https://upload.wikimedia.org/wikipedia/en/d/d7/Les_Demoiselles_d%27Avignon.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
      { id:'delaunay', title:'CarrÃ© â€” Robert Delaunay', img:'https://upload.wikimedia.org/wikipedia/commons/5/5a/Robert_Delaunay%2C_1912-13%2C_Carr%C3%A9_1912-13.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' },
      { id:'kandinsky', title:'Composition VIII â€” Kandinsky', img:'https://upload.wikimedia.org/wikipedia/commons/6/6e/Kandinsky_-_Composition_8.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' }
    ]
  },
  sculpture: {
    id:'sculpture',
    name:'Salle Sculpture & Photo',
    artworks:[
      { id:'rodin', title:'Le Penseur â€” Rodin', img:'https://upload.wikimedia.org/wikipedia/commons/8/83/Le_Penseur_Rodin.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' },
      { id:'man_ray', title:'Noir et Blanc â€” Man Ray', img:'https://upload.wikimedia.org/wikipedia/commons/3/34/Man_Ray_%281885-1976%29_-_Flatiron_Building%2C_New_York%2C_1928.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3' },
      { id:'brancusi', title:'Le Baiser â€” Brancusi', img:'https://upload.wikimedia.org/wikipedia/commons/0/02/Brancusi_Baiser.jpg', audio:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3' }
    ]
  }
};

/* ---------- State ---------- */
let currentRoom = null;
let currentAudio = null;        // HTMLAudioElement for artwork playback
let transitionAllowed = false;  // set after user enables audio overlay

// local guest sets (used when not logged)
let guestFavorites = new Set(JSON.parse(localStorage.getItem('ab_favs')||'[]'));
let guestVisited = new Set(JSON.parse(localStorage.getItem('ab_visited')||'[]'));

// users stored in localStorage under key 'ab_users'
let USERS = JSON.parse(localStorage.getItem('ab_users') || '{}');
let currentUser = localStorage.getItem('ab_current') || null; // email or null

/* ---------- DOM refs ---------- */
const grid = document.getElementById('grid');
const roomName = document.getElementById('roomName');
const roomStats = document.getElementById('roomStats');
const status = document.getElementById('status');
const networkDetails = document.getElementById('networkDetails');
const roomTitle = document.getElementById('roomTitle');
const collectionList = document.getElementById('collectionList');
const simulateBtn = document.getElementById('simulateBtn');
const audioOverlay = document.getElementById('audioOverlay');
const enableSoundBtn = document.getElementById('enableSound');
const openCollectionBtn = document.getElementById('openCollectionBtn');
const stopBtn = document.getElementById('stopBtn');

const accountBtn = document.getElementById('accountBtn');
const menuPopup = document.getElementById('menuPopup');

const loginModal = document.getElementById('loginModal');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginSubmit = document.getElementById('loginSubmit');
const registerSubmit = document.getElementById('registerSubmit');
const closeLogin = document.getElementById('closeLogin');
const collectionBox = document.getElementById('collectionBox');
const collectionInfo = document.getElementById('collectionInfo');
const collectionCTA = document.getElementById('collectionCTA');
const ctaLogin = document.getElementById('ctaLogin');

const btnForward = document.getElementById('btnForward');
const btnBack = document.getElementById('btnBack');
const simDistance = document.getElementById('simDistance');
const wifiIcon = document.getElementById('wifiIcon');

const themeToggle = document.getElementById('themeToggle');
const audioProgress = document.getElementById('audioProgress');
const progressBar = document.getElementById('progressBar');
const progressTime = document.getElementById('progressTime');

/* ---------- Helpers: storage & users ---------- */
function persistUsers(){ localStorage.setItem('ab_users', JSON.stringify(USERS)); }
function setCurrentUser(email){
  currentUser = email;
  if(email) localStorage.setItem('ab_current', email);
  else localStorage.removeItem('ab_current');
  updateAccountUI();
  renderCollection();
}

/* get favorites for active context (user if logged, else guest) */
function getFavoritesSet(){
  if(currentUser && USERS[currentUser]) return new Set(USERS[currentUser].favorites || []);
  return new Set(Array.from(guestFavorites));
}
function getVisitedSet(){
  if(currentUser && USERS[currentUser]) return new Set(USERS[currentUser].visited || []);
  return new Set(Array.from(guestVisited));
}

/* save favorites/visited back to storage for current context */
function saveFavoritesSet(set){
  if(currentUser && USERS[currentUser]){ USERS[currentUser].favorites = Array.from(set); persistUsers(); }
  else { guestFavorites = new Set(Array.from(set)); localStorage.setItem('ab_favs', JSON.stringify(Array.from(guestFavorites))); }
}
function saveVisitedSet(set){
  if(currentUser && USERS[currentUser]){ USERS[currentUser].visited = Array.from(set); persistUsers(); }
  else { guestVisited = new Set(Array.from(set)); localStorage.setItem('ab_visited', JSON.stringify(Array.from(guestVisited))); }
}

/* ---------- Helpers: misc ---------- */
function playTransitionTone(duration=120, freq=880, vol=0.15){
  if(!transitionAllowed) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine'; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, duration);
  }catch(e){ console.warn('WebAudio not available', e) }
}

/* ---------- UI rendering (artworks) ---------- */
function renderRoom(room){
  if(!room) return;
  currentRoom = room;
  playTransitionTone(); // fx when arriving in a room
  roomName.textContent = room.name;
  roomStats.textContent = `${room.artworks.length} Å“uvres`;
  roomTitle.style.display = 'flex';
  status.style.display = 'none';
  grid.innerHTML = '';

  const favSet = getFavoritesSet();
  const visitedSet = getVisitedSet();

  room.artworks.forEach(art => {
    const card = document.createElement('div');
    card.className = 'card fade-in';
    card.setAttribute('role','button');
    card.setAttribute('tabindex','0');
    card.dataset.artId = art.id;

    // show "ConsultÃ©e" badge if visited
    const consultedBadge = visitedSet.has(art.id) ? `<div class="consulted">ConsultÃ©e âœ“</div>` : '';

    card.innerHTML = `
      <img class="thumb" src="${art.img}" alt="${escapeHtml(art.title)}">
      ${consultedBadge}
      <div class="meta">
        <h3>${escapeHtml(art.title)}</h3>
        <div class="meta-row">
          <div class="muted">Cliquer pour Ã©couter</div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="icon-btn" title="Favoris" data-art="${art.id}" aria-label="Favoris">
              ${favSet.has(art.id) ? starSvg(true) : starSvg(false)}
            </button>
            <button class="icon-btn" title="Ã‰couter" data-play="${art.id}" aria-label="Ã‰couter">
              ${playSvg()}
            </button>
          </div>
        </div>
      </div>
    `;

    card.addEventListener('click', (e)=>{
      const favBtn = e.target.closest('button[data-art]');
      const playBtn = e.target.closest('button[data-play]');
      if(favBtn){ toggleFav(favBtn.getAttribute('data-art')); e.stopPropagation(); return; }
      if(playBtn){ playArtworkById(playBtn.getAttribute('data-play')); e.stopPropagation(); return; }
      playArtworkById(art.id);
    });

    card.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); playArtworkById(art.id); }
    });

    grid.appendChild(card);
  });

  // if audio is currently playing, reapply badge
  updateAudioBadge();
}

/* escape helper */
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

/* ---------- Audio management ---------- */
let _audioProgressInterval = null;

function stopCurrentAudio(){
  if(currentAudio){
    try{
      currentAudio.pause();
      currentAudio.currentTime = 0;
    }catch(e){}
    currentAudio = null;
  }
  stopBtn.style.display = 'none';
  const stopLegacy = document.getElementById('stop');
  if(stopLegacy) stopLegacy.style.display = 'none';

  // clear progress interval
  if(_audioProgressInterval){
    clearInterval(_audioProgressInterval);
    _audioProgressInterval = null;
  }
  // hide progress UI
  audioProgress.style.display = 'none';
  progressBar.value = 0;
  progressTime.textContent = '0:00';

  document.querySelectorAll('.card.playing').forEach(c => c.classList.remove('playing'));
  document.querySelectorAll('.card .playing-badge').forEach(b => b.remove());
}

/* legacy global called by inline onclick */
function stopAudio(){ stopCurrentAudio(); }

/* Play artwork by id */
function playArtworkById(id){
  const art = findArtwork(id);
  if(!art) return;
  if(!transitionAllowed){
    showAudioOverlay();
    return;
  }

  playTransitionTone(90,1200,0.08);
  stopCurrentAudio();

  currentAudio = new Audio(art.audio);
  currentAudio.preload = 'auto';
  currentAudio._artId = art.id;

  currentAudio.addEventListener('canplaythrough', ()=>{
    currentAudio.play().catch(()=>{/* blocked */});
  });

  currentAudio.addEventListener('timeupdate', ()=>{
    // timeupdate handled via interval for better control
  });

  currentAudio.addEventListener('ended', ()=>{
    currentAudio = null;
    stopBtn.style.display = 'none';
    const stopLegacy = document.getElementById('stop');
    if(stopLegacy) stopLegacy.style.display = 'none';
    document.querySelectorAll('.card.playing').forEach(c => c.classList.remove('playing'));
    document.querySelectorAll('.card .playing-badge').forEach(b => b.remove());
    // clear interval & hide progress
    if(_audioProgressInterval){ clearInterval(_audioProgressInterval); _audioProgressInterval = null; }
    audioProgress.style.display = 'none';
    progressBar.value = 0;
    progressTime.textContent = '0:00';
  });

  stopBtn.style.display = 'block';
  const stopLegacy = document.getElementById('stop');
  if(stopLegacy) stopLegacy.style.display = 'inline-block';

  // mark visited & update UI
  const visitedSet = getVisitedSet();
  visitedSet.add(art.id);
  saveVisitedSet(visitedSet);
  renderCollection();
  // re-render room to show consulted badge on cards
  if(currentRoom) renderRoom(currentRoom);

  flashArtworkCard(id);

  // badge
  const playButtons = document.querySelectorAll(`[data-play="${id}"]`);
  if(playButtons.length){
    const card = playButtons[0].closest('.card');
    if(card){
      card.classList.add('playing');
      const badge = document.createElement('div');
      badge.className = 'playing-badge';
      badge.textContent = 'En lectureâ€¦';
      card.appendChild(badge);
    }
  }

  // show & update progress bar via interval
  audioProgress.style.display = 'flex';
  progressBar.value = 0;
  progressTime.textContent = '0:00';
  if(_audioProgressInterval) clearInterval(_audioProgressInterval);
  _audioProgressInterval = setInterval(()=>{
    if(!currentAudio) return;
    const dur = currentAudio.duration || 0;
    const cur = currentAudio.currentTime || 0;
    if(dur && !isNaN(dur)){
      const pct = (cur/dur)*100;
      progressBar.value = pct;
      progressTime.textContent = formatTime(cur) + (dur ? ' / ' + formatTime(dur) : '');
    } else {
      progressBar.value = 0;
      progressTime.textContent = formatTime(cur);
    }
  }, 250);
}

/* format seconds to mm:ss */
function formatTime(s){
  if(!s || isNaN(s)) s = 0;
  const mm = Math.floor(s/60);
  const ss = Math.floor(s%60);
  return `${mm}:${ss.toString().padStart(2,'0')}`;
}

/* update audio badge if audio present */
function updateAudioBadge(){
  document.querySelectorAll('.card.playing').forEach(c => c.classList.remove('playing'));
  document.querySelectorAll('.card .playing-badge').forEach(b => b.remove());
  if(currentAudio && currentAudio._artId){
    const card = document.querySelector(`.card[data-art-id="${currentAudio._artId}"]`);
    if(card){
      card.classList.add('playing');
      const badge = document.createElement('div');
      badge.className = 'playing-badge';
      badge.textContent = 'En lectureâ€¦';
      card.appendChild(badge);
    }
  }
}

/* find art in ROOMS */
function findArtwork(id){
  for(const r of Object.values(ROOMS)){
    for(const a of r.artworks) if(a.id === id) return a;
  }
  return null;
}

/* flash card */
function flashArtworkCard(id){
  const btns = [...document.querySelectorAll(`[data-play="${id}"]`)];
  if(btns.length>0){
    const card = btns[0].closest('.card');
    card.style.transition = 'transform .12s';
    card.style.transform = 'scale(1.02)';
    setTimeout(()=>{ card.style.transform = ''; }, 260);
  }
}

/* ---------- Favorites & Collection ---------- */
function toggleFav(id){
  const favSet = getFavoritesSet();
  if(favSet.has(id)) favSet.delete(id); else favSet.add(id);
  saveFavoritesSet(favSet);
  renderRoom(currentRoom);
  renderCollection();
}

function renderCollection(){
  collectionList.innerHTML = '';
  const favSet = getFavoritesSet();
  const visitedSet = getVisitedSet();

  if(!currentUser){
    collectionBox.classList.add('locked');
    collectionInfo.textContent = "Connecte-toi pour sauvegarder et retrouver ta collection.";
    collectionCTA.style.display = 'flex';
  } else {
    collectionBox.classList.remove('locked');
    collectionInfo.textContent = `ConnectÃ© en tant que ${currentUser}`;
    collectionCTA.style.display = 'none';
  }

  if(favSet.size>0){
    const favHeader = document.createElement('li'); favHeader.textContent = 'Favoris'; favHeader.style.fontWeight='700';
    collectionList.appendChild(favHeader);
    for(const id of favSet){
      const art = findArtwork(id);
      if(!art) continue;
      const li = document.createElement('li');
      li.innerHTML = `${escapeHtml(art.title)} <button class="btn small" style="float:right" onclick="playArtworkById('${art.id}')">Ã‰couter</button>`;
      collectionList.appendChild(li);
    }
  }

  const otherVisited = [...visitedSet].filter(id=>!favSet.has(id));
  if(otherVisited.length>0){
    const header = document.createElement('li'); header.textContent = 'ConsultÃ©es'; header.style.fontWeight='700'; header.style.marginTop='8px';
    collectionList.appendChild(header);
    otherVisited.forEach(id=>{
      const art = findArtwork(id);
      if(!art) return;
      const li = document.createElement('li');
      li.innerHTML = `${escapeHtml(art.title)} <button class="btn small" style="float:right" onclick="playArtworkById('${art.id}')">Ã‰couter</button>`;
      collectionList.appendChild(li);
    });
  }

  if(favSet.size===0 && otherVisited.length===0){
    const li = document.createElement('li'); li.textContent = 'Aucune Å“uvre pour le moment. Cliquez sur une Å“uvre pour lâ€™Ã©couter.'; collectionList.appendChild(li);
  }
}

/* ---------- Save helpers repeated safely ---------- */
function saveFavoritesSet(set){
  if(currentUser){
    if(!USERS[currentUser]) USERS[currentUser] = { password:'', favorites:[], visited:[] };
    USERS[currentUser].favorites = Array.from(set);
    persistUsers();
  } else {
    guestFavorites = new Set(Array.from(set));
    localStorage.setItem('ab_favs', JSON.stringify(Array.from(guestFavorites)));
  }
}
function saveVisitedSet(set){
  if(currentUser){
    if(!USERS[currentUser]) USERS[currentUser] = { password:'', favorites:[], visited:[] };
    USERS[currentUser].visited = Array.from(set);
    persistUsers();
  } else {
    guestVisited = new Set(Array.from(set));
    localStorage.setItem('ab_visited', JSON.stringify(Array.from(guestVisited)));
  }
}

/* ---------- OPTION A: Avancer / Reculer (distance 0 â†’ 30m) ---------- */
let distance = 0; // meters (0..30)
const MIN_DIST = 0;
const MAX_DIST = 30;

function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function changeDistance(delta){
  distance = clamp(distance + delta, MIN_DIST, MAX_DIST);
  simDistance.textContent = distance;
  updateWifiIcon();
  updateRoomFromDistance();
}

function updateWifiIcon(){
  if(!wifiIcon) return;
  if(distance <= 10) wifiIcon.textContent = 'ðŸ“¶ðŸ“¶ðŸ“¶';
  else if(distance <= 20) wifiIcon.textContent = 'ðŸ“¶ðŸ“¶';
  else wifiIcon.textContent = 'ðŸ“¶';
}

function updateRoomFromDistance(){
  let target = null;
  if(distance <= 10) target = ROOMS.impressionnisme;
  else if(distance <= 20) target = ROOMS.modernisme;
  else target = ROOMS.sculpture;

  if(!currentRoom || currentRoom.id !== target.id){
    renderRoom(target);
    status.textContent = `Distance: ${distance} m â€” Salle sÃ©lectionnÃ©e : ${target.name}`;
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

/* simulate button: activates the Option A simulation initial state */
function simulateDetection(){
  status.textContent = 'Simulation Wi-Fi dÃ©marrÃ©e (Option A)â€¦';
  // start from a default distance (0) and render accordingly
  distance = 0;
  simDistance.textContent = distance;
  updateWifiIcon();
  updateRoomFromDistance();
}

/* wire forward/back buttons (guard if null) */
if(btnForward) btnForward.addEventListener('click', ()=>changeDistance(+5));
if(btnBack) btnBack.addEventListener('click', ()=>changeDistance(-5));

/* ---------- Overlay & initial activation ---------- */
function showAudioOverlay(){ audioOverlay.style.display='flex'; }
function hideAudioOverlay(){ audioOverlay.style.display='none'; }

/* ---------- Utility svg icons ---------- */
function starSvg(active=false){
  if(active){
    return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 17.3l-6.16 3.24 1.18-6.88L2.7 9.76l6.95-1.01L12 2.5l2.35 6.25 6.95 1.01-4.32 4.9 1.18 6.88z" fill="#FFCC00"/></svg>`;
  }
  return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 17.3l-6.16 3.24 1.18-6.88L2.7 9.76l6.95-1.01L12 2.5l2.35 6.25 6.95 1.01-4.32 4.9 1.18 6.88z" stroke="#bbb" stroke-width="1.2" fill="none"/></svg>`;
}
function playSvg(){
  return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M5 3v18l15-9z" fill="#6a5acd"/></svg>`;
}

/* ---------- Account / Login logic ---------- */
function updateAccountUI(){
  if(currentUser && USERS[currentUser]){
    accountBtn.textContent = currentUser;
    menuPopup.innerHTML = `
      <button onclick="viewProfile()">Mon compte</button>
      <button onclick="logout()">Se dÃ©connecter</button>
    `;
    menuPopup.style.display = 'none';
    menuPopup.setAttribute('aria-hidden','true');
  } else {
    accountBtn.textContent = 'Connexion';
    menuPopup.innerHTML = `<button onclick="openLoginModal()">Se connecter / CrÃ©er un compte</button>`;
    menuPopup.style.display = 'none';
    menuPopup.setAttribute('aria-hidden','true');
  }
}

accountBtn.addEventListener('click', ()=>{
  if(menuPopup.style.display === 'block'){ menuPopup.style.display = 'none'; menuPopup.setAttribute('aria-hidden','true'); }
  else { menuPopup.style.display = 'block'; menuPopup.setAttribute('aria-hidden','false'); }
});

function openLoginModal(){
  loginModal.style.display = 'flex';
  loginModal.setAttribute('aria-hidden','false');
  menuPopup.style.display = 'none';
  menuPopup.setAttribute('aria-hidden','true');
}

closeLogin.addEventListener('click', ()=>{
  loginModal.style.display = 'none';
  loginModal.setAttribute('aria-hidden','true');
});

loginSubmit.addEventListener('click', ()=>{
  const email = (loginEmail.value || '').trim().toLowerCase();
  const pass = (loginPassword.value || '').trim();
  if(!email || !pass){ alert('Email et mot de passe requis'); return; }
  if(!USERS[email]){ alert('Compte introuvable. CrÃ©ez un compte.'); return; }
  if(USERS[email].password !== pass){ alert('Mot de passe incorrect'); return; }
  setCurrentUser(email);
  loginModal.style.display = 'none';
  loginModal.setAttribute('aria-hidden','true');
  USERS[email].favorites = USERS[email].favorites || [];
  USERS[email].visited = USERS[email].visited || [];
  persistUsers();
  renderRoom(currentRoom || ROOMS[Object.keys(ROOMS)[0]]);
  alert('ConnectÃ© en tant que ' + email);
});

registerSubmit.addEventListener('click', ()=>{
  const email = (loginEmail.value || '').trim().toLowerCase();
  const pass = (loginPassword.value || '').trim();
  if(!email || !pass){ alert('Email et mot de passe requis'); return; }
  if(USERS[email]){ alert('Ce compte existe dÃ©jÃ '); return; }
  USERS[email] = { password: pass, favorites: Array.from(guestFavorites), visited: Array.from(guestVisited) };
  persistUsers();
  setCurrentUser(email);
  loginModal.style.display = 'none';
  loginModal.setAttribute('aria-hidden','true');
  alert('Compte crÃ©Ã© et connectÃ© : ' + email);
});

function viewProfile(){
  menuPopup.style.display = 'none';
  menuPopup.setAttribute('aria-hidden','true');
  alert('Profil: ' + currentUser + '\nFavoris: ' + JSON.stringify(USERS[currentUser].favorites || []) );
}

function logout(){
  setCurrentUser(null);
  alert('DÃ©connectÃ©');
}

ctaLogin.addEventListener('click', ()=>{ openLoginModal(); });

/* ---------- keyboard + UI wiring ---------- */
simulateBtn.addEventListener('click', simulateDetection);
openCollectionBtn.addEventListener('click', ()=>{ window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); });

enableSoundBtn.addEventListener('click', ()=>{
  transitionAllowed = true;
  playTransitionTone(80,1000,0.06);
  hideAudioOverlay();
});

/* ---------- Theme toggle (manual) ---------- */
function applySavedTheme(){
  const saved = localStorage.getItem('ab_theme');
  if(saved === 'dark'){
    document.body.classList.add('dark');
  } else {
    document.body.classList.remove('dark');
  }
  updateThemeIcon();
}
function toggleTheme(){
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('ab_theme', isDark ? 'dark' : 'light');
  updateThemeIcon();
}
function updateThemeIcon(){
  if(document.body.classList.contains('dark')) themeToggle.textContent = 'ðŸŒ™';
  else themeToggle.textContent = 'ðŸŒ“';
}
themeToggle.addEventListener('click', toggleTheme);

/* ---------- Initial load ---------- */
window.addEventListener('load', ()=>{
  // show overlay once so user can opt-in to audio
  audioOverlay.style.display = 'flex';
  // validate currentUser exists in USERS
  if(currentUser && !USERS[currentUser]){ currentUser = null; localStorage.removeItem('ab_current'); }
  updateAccountUI();
  renderCollection();
  // init Option A display
  simDistance.textContent = distance;
  updateWifiIcon();
  // optionally show a default room
  renderRoom(ROOMS[Object.keys(ROOMS)[0]]);
  // apply theme
  applySavedTheme();
});
/* expose helpers globally for inline onclicks */
window.playArtworkById = playArtworkById;
window.toggleFav = toggleFav;
window.stopCurrentAudio = stopCurrentAudio;
window.stopAudio = stopAudio;
</script>
</body>
</html>
